#!/usr/bin/env python3
# StratusScan.py - Main menu script for AWS resource export tools

"""
===========================
= AWS RESOURCE SCANNER =
===========================

Title: StratusScan - AWS Resource Exporter Main Menu
Version: v2.2.0
Date: NOV-10-2025

Description:
This script provides a centralized interface for executing various AWS resource
export tools within the StratusScan package. It allows users to select which resource
type to export (EC2 instances, VPC resources, etc.) and calls the appropriate script
to perform the selected operation.

Features:
- Updated for AWS Commercial environment
- Trusted Advisor enabled and available
- Default regions set to us-east-1 and us-west-2
- All AWS services and regions available
- Updated partition handling for standard aws

Deployment Structure:
- The main menu script should be located in the root directory of the StratusScan package
- Individual export scripts should be located in the 'scripts' subdirectory
- Exported files will be saved to the 'output' subdirectory
- Account mappings and configuration are stored in config.json
"""

import os
import sys
import subprocess
import zipfile
import datetime
from pathlib import Path

# Add the current directory to the path to ensure we can import utils
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# Import the utility module
try:
    import utils
except ImportError:
    print("ERROR: Could not import the utils module. Make sure utils.py is in the same directory as this script.")
    sys.exit(1)

# Initialize logging for main menu
SCRIPT_START_TIME = datetime.datetime.now()
utils.setup_logging("main-menu", log_to_file=True)
utils.log_script_start("stratusscan.py", "AWS Resource Scanner Main Menu")
utils.log_system_info()

def clear_screen():
    """
    Clear the terminal screen based on the operating system.
    """
    # Check if we're on Windows or Unix/Linux/MacOS
    if os.name == 'nt':  # Windows
        os.system('cls')
    else:  # Unix/Linux/MacOS
        os.system('clear')

def print_header():
    """
    Print the main menu header with version information.
    
    Returns:
        tuple: (account_id, account_name) - The AWS account information
    """
    clear_screen()
    print("====================================================================")
    print("                   AWS RESOURCE SCANNER                            ")
    print("====================================================================")
    print("                         STRATUSSCAN                                ")
    print("                   AWS RESOURCE EXPORTER MENU                      ")
    print("====================================================================")
    print("Version: v2.2.0                                Date: NOV-10-2025")
    print("Environment: AWS Commercial")
    print("====================================================================")
    
    # Get the current AWS account ID and map to account name
    try:
        # Create a boto3 STS client
        import boto3
        sts = boto3.client('sts')
        account_id = sts.get_caller_identity()["Account"]
        account_name = utils.get_account_name(account_id, default=account_id)
        
        # Validate AWS connection
        try:
            caller_arn = sts.get_caller_identity()["Arn"]
            # This tool is optimized for AWS Commercial environments
        except Exception:
            pass  # Continue if we can't validate the partition
        
        print(f"Account ID: {account_id}")
        print(f"Account Name: {account_name}")
    except Exception as e:
        print(f"Error getting account information: {e}")
        account_id = "UNKNOWN"
        account_name = "UNKNOWN-ACCOUNT"
    
    print("====================================================================")
    return account_id, account_name

def check_dependency(dependency):
    """
    Check if a Python dependency is installed.
    
    Args:
        dependency: Name of the Python package to check
        
    Returns:
        bool: True if installed, False otherwise
    """
    try:
        __import__(dependency)
        return True
    except ImportError:
        return False

def install_dependency(dependency):
    """
    Install a Python dependency after user confirmation.
    
    Args:
        dependency: Name of the Python package to install
        
    Returns:
        bool: True if installed successfully, False otherwise
    """
    print(f"\nPackage '{dependency}' is required but not installed.")
    response = input(f"Would you like to install {dependency}? (y/n): ").lower()
    
    if response == 'y':
        try:
            import subprocess
            print(f"Installing {dependency}...")
            subprocess.check_call([sys.executable, "-m", "pip", "install", dependency])
            print(f"[SUCCESS] Successfully installed {dependency}")
            return True
        except Exception as e:
            print(f"Error installing {dependency}: {e}")
            return False
    else:
        print(f"Cannot proceed without {dependency}.")
        return False

def check_dependencies():
    """
    Check and install common required dependencies.
    
    Returns:
        bool: True if all dependencies are satisfied, False otherwise
    """
    print("Checking required dependencies...")
    required_packages = ['boto3', 'pandas', 'openpyxl']
    
    for package in required_packages:
        if check_dependency(package):
            print(f"[OK] {package} is already installed")
        else:
            if not install_dependency(package):
                return False
    
    return True

def ensure_directory_structure():
    """
    Ensure the required directory structure exists.
    Creates the scripts and output directories if they don't exist.
    
    Returns:
        tuple: (scripts_dir, output_dir) - Paths to the scripts and output directories
    """
    # Get the base directory (where this script is located)
    base_dir = Path(__file__).parent.absolute()
    
    # Create scripts directory if it doesn't exist
    scripts_dir = base_dir / "scripts"
    if not scripts_dir.exists():
        print(f"Creating scripts directory: {scripts_dir}")
        scripts_dir.mkdir(exist_ok=True)
    
    # Create output directory if it doesn't exist
    output_dir = base_dir / "output"
    if not output_dir.exists():
        print(f"Creating output directory: {output_dir}")
        output_dir.mkdir(exist_ok=True)
    
    # Check if config.json exists, create default if it doesn't
    config_path = base_dir / "config.json"

    if not config_path.exists():
        print(f"No configuration file found. The config.json file should exist.")
        print(f"Please ensure config.json is present in the StratusScan directory.")
        print(f"You may want to edit this file to add your account mappings.")
    
    return scripts_dir, output_dir

def execute_script(script_path):
    """
    Execute the selected export script.

    Args:
        script_path (Path): Path to the script to execute

    Returns:
        bool: True if the script executed successfully, False otherwise
    """
    start_time = datetime.datetime.now()
    script_name = script_path.name

    try:
        # Log script execution start
        utils.log_section(f"EXECUTING SCRIPT: {script_name}")
        utils.log_info(f"Script path: {script_path}")
        utils.log_info(f"Execution start time: {start_time}")

        # Clear the screen before executing the script
        clear_screen()

        print(f"Executing: {script_path}")
        print("=" * 60)

        # Execute the script as a subprocess
        result = subprocess.run([sys.executable, str(script_path)],
                              check=True)

        if result.returncode == 0:
            print("\nScript execution completed successfully.")
            utils.log_success(f"Script executed successfully: {script_name}")
            return True
        else:
            print(f"\nScript execution failed with return code: {result.returncode}")
            utils.log_error(f"Script execution failed: {script_name} (return code: {result.returncode})")
            return False

    except subprocess.CalledProcessError as e:
        print(f"Error executing script: {e}")
        utils.log_error(f"Script execution error: {script_name}", e)
        return False
    except Exception as e:
        print(f"Unexpected error during script execution: {e}")
        utils.log_error(f"Unexpected error executing script: {script_name}", e)
        return False
    finally:
        # Log execution completion
        end_time = datetime.datetime.now()
        duration = end_time - start_time
        utils.log_info(f"Script execution completed: {script_name}")
        utils.log_info(f"Execution duration: {duration}")

def create_output_archive(account_name):
    """
    Create a zip archive of the output directory.
    
    Args:
        account_name: The AWS account name to use in the filename
        
    Returns:
        bool: True if archive was created successfully, False otherwise
    """
    try:
        # Clear the screen
        clear_screen()
        
        print("====================================================================")
        print("CREATING OUTPUT ARCHIVE")
        print("====================================================================")
        
        # Get the output directory path
        output_dir = Path(__file__).parent / "output"
        
        # Check if output directory exists and has files
        if not output_dir.exists():
            print(f"Output directory not found: {output_dir}")
            return False
        
        files = list(output_dir.glob("*.*"))
        if not files:
            print("No files found in the output directory to archive.")
            return False
        
        print(f"Found {len(files)} files to archive.")
        
        # Create filename with current date
        current_date = datetime.datetime.now().strftime("%m.%d.%Y")
        zip_filename = f"{account_name}-export-{current_date}.zip"
        zip_path = Path(__file__).parent / zip_filename
        
        # Create the zip file
        print(f"Creating archive: {zip_filename}")
        print("Please wait...")
        
        with zipfile.ZipFile(zip_path, 'w', zipfile.ZIP_DEFLATED) as zipf:
            for file in files:
                # Archive file with relative path inside the zip
                zipf.write(file, arcname=file.name)
                print(f"  Added: {file.name}")
        
        print("\nArchive creation completed successfully!")
        print(f"Archive saved to: {zip_path}")
        
        return True
    
    except Exception as e:
        print(f"Error creating archive: {e}")
        return False

def get_menu_structure():
    """
    Create a hierarchical menu structure with main categories and submenus.
    Updated for AWS Commercial environment - includes all available services.

    Returns:
        dict: Dictionary with main menu options and their corresponding submenus
    """
    scripts_dir, _ = ensure_directory_structure()
    
    # Define the menu structure with categories and script mappings
    menu_structure = {
        "0": {
            "name": "Configure StratusScan",
            "file": Path(__file__).parent / "configure.py",
            "description": "Interactive configuration tool for account mappings and AWS settings"
        },
        "1": {
            "name": "Service Discovery",
            "file": scripts_dir / "services-in-use-export.py",
            "description": "Discover all AWS services in use (both billing and non-billing services)"
        },
        "2": {
            "name": "Compute Resources",
            "submenu": {
                "1": {
                    "name": "EC2",
                    "file": scripts_dir / "ec2-export.py",
                    "description": "Export EC2 instance data"
                },
                "2": {
                    "name": "RDS",
                    "file": scripts_dir / "rds-export.py",
                    "description": "Export RDS instance information"
                },
                "3": {
                    "name": "EKS",
                    "file": scripts_dir / "eks-export.py",
                    "description": "Export EKS cluster information"
                },
                "4": {
                    "name": "ECS",
                    "file": scripts_dir / "ecs-export.py",
                    "description": "Export ECS cluster and service information"
                },
                "5": {
                    "name": "Auto Scaling Groups",
                    "file": scripts_dir / "autoscaling-export.py",
                    "description": "Export Auto Scaling Group configurations, instances, and scaling policies"
                },
                "6": {
                    "name": "Lambda Functions",
                    "file": scripts_dir / "lambda-export.py",
                    "description": "Export Lambda function configurations, event sources, and concurrency settings"
                },
                "7": {
                    "name": "ECR (Elastic Container Registry)",
                    "file": scripts_dir / "ecr-export.py",
                    "description": "Export ECR repositories, images, vulnerability scans, and lifecycle policies"
                },
                "8": {
                    "name": "AMI (Amazon Machine Images)",
                    "file": scripts_dir / "ami-export.py",
                    "description": "Export account-owned AMIs with architecture, platform, and snapshot details"
                },
                "9": {
                    "name": "EC2 Image Builder",
                    "file": scripts_dir / "image-builder-export.py",
                    "description": "Export Image Builder pipelines, recipes, components, and infrastructure configurations"
                },
                "10": {
                    "name": "All Compute Resources",
                    "file": scripts_dir / "compute-resources.py",
                    "description": "Export all compute resources (EC2, RDS, EKS, ECS) in one comprehensive report"
                },
                "11": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "3": {
            "name": "Storage Resources",
            "submenu": {
                "1": {
                    "name": "EBS Volumes",
                    "file": scripts_dir / "ebs-volumes-export.py",
                    "description": "Export EBS volume information"
                },
                "2": {
                    "name": "EBS Snapshots",
                    "file": scripts_dir / "ebs-snapshots-export.py",
                    "description": "Export EBS snapshot information"
                },
                "3": {
                    "name": "S3",
                    "file": scripts_dir / "s3-export.py",
                    "description": "Export S3 bucket information"
                },
                "4": {
                    "name": "EFS (Elastic File System)",
                    "file": scripts_dir / "efs-export.py",
                    "description": "Export EFS file systems, mount targets, and access points"
                },
                "5": {
                    "name": "FSx",
                    "file": scripts_dir / "fsx-export.py",
                    "description": "Export FSx file systems (Windows, Lustre, ONTAP, OpenZFS) and backups"
                },
                "6": {
                    "name": "AWS Backup",
                    "file": scripts_dir / "backup-export.py",
                    "description": "Export AWS Backup vaults, backup plans, and backup selections"
                },
                "7": {
                    "name": "S3 Access Points",
                    "file": scripts_dir / "s3-accesspoints-export.py",
                    "description": "Export S3 Access Points (standard, multi-region, Object Lambda) with VPC configs and policies"
                },
                "8": {
                    "name": "DataSync",
                    "file": scripts_dir / "datasync-export.py",
                    "description": "Export DataSync tasks, locations (S3/EFS/FSx/NFS/SMB), agents, and execution history"
                },
                "9": {
                    "name": "Transfer Family",
                    "file": scripts_dir / "transfer-family-export.py",
                    "description": "Export Transfer Family servers (SFTP/FTPS/FTP/AS2), users, connectors, workflows, and certificates"
                },
                "10": {
                    "name": "Storage Gateway",
                    "file": scripts_dir / "storagegateway-export.py",
                    "description": "Export Storage Gateway gateways (File/Volume/Tape), file shares, volumes, tapes, and local disks"
                },
                "11": {
                    "name": "All Storage Resources",
                    "file": scripts_dir / "storage-resources.py",
                    "description": "Export all storage resources (EBS, S3) in one comprehensive report"
                },
                "12": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "4": {
            "name": "Network Resources",
            "submenu": {
                "1": {
                    "name": "VPC/Subnet",
                    "file": scripts_dir / "vpc-data-export.py",
                    "description": "Export VPC and subnet information"
                },
                "2": {
                    "name": "ELB",
                    "file": scripts_dir / "elb-export.py",
                    "description": "Export load balancer information"
                },
                "3": {
                    "name": "Network ACLs",
                    "file": scripts_dir / "nacl-export.py",
                    "description": "Export Network ACL information"
                },
                "4": {
                    "name": "Security Groups",
                    "file": scripts_dir / "security-groups-export.py",
                    "description": "Export security group rules and associations"
                },
                "5": {
                    "name": "Route Tables",
                    "file": scripts_dir / "route-tables-export.py",
                    "description": "Export route table information"
                },
                "6": {
                    "name": "CloudFront",
                    "file": scripts_dir / "cloudfront-export.py",
                    "description": "Export CloudFront distribution configurations, origins, and cache behaviors"
                },
                "7": {
                    "name": "Route 53",
                    "file": scripts_dir / "route53-export.py",
                    "description": "Export Route 53 hosted zones, DNS records, health checks, and Resolver configurations"
                },
                "8": {
                    "name": "VPN",
                    "file": scripts_dir / "vpn-export.py",
                    "description": "Export Site-to-Site VPN connections, Client VPN endpoints, and gateway configurations"
                },
                "9": {
                    "name": "Direct Connect",
                    "file": scripts_dir / "directconnect-export.py",
                    "description": "Export Direct Connect connections, virtual interfaces, LAGs, and gateways (premium service)"
                },
                "10": {
                    "name": "Global Accelerator",
                    "file": scripts_dir / "globalaccelerator-export.py",
                    "description": "Export Global Accelerator configurations, listeners, endpoint groups, and endpoints (premium service)"
                },
                "11": {
                    "name": "Transit Gateway",
                    "file": scripts_dir / "transit-gateway-export.py",
                    "description": "Export Transit Gateway configurations, attachments, route tables, and routes"
                },
                "12": {
                    "name": "AWS Network Firewall",
                    "file": scripts_dir / "network-firewall-export.py",
                    "description": "Export Network Firewall configurations, policies, rule groups, and logging settings"
                },
                "13": {
                    "name": "All Network Resources",
                    "file": scripts_dir / "network-resources.py",
                    "description": "Export all network resources (VPC, ELB, NACLs, Security Groups, Route Tables) in one comprehensive report"
                },
                "14": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "5": {
            "name": "Security Resources",
            "submenu": {
                "1": {
                    "name": "Security Hub",
                    "file": scripts_dir / "security-hub-export.py",
                    "description": "Export Security Hub findings with severity, compliance status, and remediation guidance"
                },
                "2": {
                    "name": "GuardDuty",
                    "file": scripts_dir / "guardduty-export.py",
                    "description": "Export GuardDuty detectors, findings, threat intel sets, and IP sets for threat detection"
                },
                "3": {
                    "name": "AWS WAF",
                    "file": scripts_dir / "waf-export.py",
                    "description": "Export WAF web ACLs, rules, IP sets, and regex patterns for application protection"
                },
                "4": {
                    "name": "CloudTrail",
                    "file": scripts_dir / "cloudtrail-export.py",
                    "description": "Export CloudTrail trails, event selectors, and insight selectors for audit logging"
                },
                "5": {
                    "name": "AWS Config",
                    "file": scripts_dir / "config-export.py",
                    "description": "Export Config recorders, rules, compliance status, and conformance packs"
                },
                "6": {
                    "name": "KMS (Key Management Service)",
                    "file": scripts_dir / "kms-export.py",
                    "description": "Export KMS keys, aliases, grants, rotation status, and encryption configurations"
                },
                "7": {
                    "name": "Secrets Manager",
                    "file": scripts_dir / "secrets-manager-export.py",
                    "description": "Export Secrets Manager secrets metadata, rotation configs, and replication settings (no secret values)"
                },
                "8": {
                    "name": "ACM (Certificate Manager)",
                    "file": scripts_dir / "acm-export.py",
                    "description": "Export ACM SSL/TLS certificates with validation methods, expiration dates, and usage tracking"
                },
                "9": {
                    "name": "IAM Access Analyzer",
                    "file": scripts_dir / "access-analyzer-export.py",
                    "description": "Export Access Analyzer findings, analyzers, archive rules, and external access detection"
                },
                "10": {
                    "name": "Detective",
                    "file": scripts_dir / "detective-export.py",
                    "description": "Export Detective behavior graphs, member accounts, invitations, and security investigation capabilities"
                },
                "11": {
                    "name": "Shield Advanced",
                    "file": scripts_dir / "shield-export.py",
                    "description": "Export Shield Advanced DDoS protection: subscription, protections, attacks, DRT access (premium service ~$3k/month)"
                },
                "12": {
                    "name": "IAM Roles Anywhere",
                    "file": scripts_dir / "iam-rolesanywhere-export.py",
                    "description": "Export IAM Roles Anywhere trust anchors, profiles, CRLs, and workload identity federation for on-premises X.509 certificates"
                },
                "13": {
                    "name": "Verified Access",
                    "file": scripts_dir / "verifiedaccess-export.py",
                    "description": "Export Verified Access instances, trust providers, groups, endpoints, and zero-trust network access configurations"
                },
                "14": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "6": {
            "name": "Identity and Access Management Resources",
            "submenu": {
                "1": {
                    "name": "IAM",
                    "description": "Traditional IAM resources (users, roles, policies)",
                    "submenu": {
                        "1": {
                            "name": "IAM Users",
                            "file": scripts_dir / "iam-export.py",
                            "description": "Export IAM user information, permissions, and security details"
                        },
                        "2": {
                            "name": "IAM Roles",
                            "file": scripts_dir / "iam-roles-export.py",
                            "description": "Export IAM role information, trust relationships, and usage patterns"
                        },
                        "3": {
                            "name": "IAM Policies",
                            "file": scripts_dir / "iam-policies-export.py",
                            "description": "Export IAM policy information, risk assessment, and compliance analysis"
                        },
                        "4": {
                            "name": "All the above",
                            "file": scripts_dir / "iam-comprehensive-export.py",
                            "description": "Export all IAM resources (users, roles, policies) in one comprehensive report"
                        },
                        "5": {
                            "name": "Return to Previous Menu",
                            "file": None,
                            "description": "Return to the previous menu"
                        }
                    }
                },
                "2": {
                    "name": "AWS Organizations",
                    "file": scripts_dir / "organizations-export.py",
                    "description": "Export AWS Organizations structure, accounts, and organizational units"
                },
                "3": {
                    "name": "IAM Identity Center",
                    "description": "IAM Identity Center (formerly AWS SSO) resources",
                    "submenu": {
                        "1": {
                            "name": "IAM Identity Center",
                            "file": scripts_dir / "iam-identity-center-export.py",
                            "description": "Export IAM Identity Center users, groups, and permission sets"
                        },
                        "2": {
                            "name": "IAM Identity Center Groups",
                            "file": scripts_dir / "iam-identity-center-groups-export.py",
                            "description": "Export IAM Identity Center groups with detailed member information"
                        },
                        "3": {
                            "name": "IAM Identity Center Permission Sets",
                            "file": scripts_dir / "iam-identity-center-permission-sets-export.py",
                            "description": "Export IAM Identity Center permission sets and assignments"
                        },
                        "4": {
                            "name": "IAM Identity Center Comprehensive",
                            "file": scripts_dir / "iam-identity-center-comprehensive-export.py",
                            "description": "Export comprehensive IAM Identity Center data (users, groups, permission sets, assignments) in one report"
                        },
                        "5": {
                            "name": "Return to Previous Menu",
                            "file": None,
                            "description": "Return to the previous menu"
                        }
                    }
                },
                "4": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "7": {
            "name": "Billing and Cost Management",
            "submenu": {
                "1": {
                    "name": "Billing Export",
                    "file": scripts_dir / "billing-export.py",
                    "description": "Export AWS billing and cost data"
                },
                "2": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "8": {
            "name": "Cost Optimization Resources",
            "submenu": {
                "1": {
                    "name": "Cost Optimization Hub",
                    "file": scripts_dir / "cost-optimization-hub-export.py",
                    "description": "Export AWS Cost Optimization Hub recommendations (aggregates Trusted Advisor, Compute Optimizer, and Cost Explorer)"
                },
                "2": {
                    "name": "Trusted Advisor - Cost Optimization",
                    "file": scripts_dir / "trusted-advisor-cost-optimization-export.py",
                    "description": "Export Trusted Advisor cost optimization recommendations (requires Business/Enterprise Support)"
                },
                "3": {
                    "name": "Compute Optimizer",
                    "file": scripts_dir / "compute-optimizer-export.py",
                    "description": "Export AWS Compute Optimizer recommendations for EC2, RDS, Lambda, and ECS"
                },
                "4": {
                    "name": "Savings Plans",
                    "file": scripts_dir / "savings-plans-export.py",
                    "description": "Export Savings Plans (Compute, EC2, SageMaker) with commitment details and savings estimates"
                },
                "5": {
                    "name": "AWS Budgets",
                    "file": scripts_dir / "budgets-export.py",
                    "description": "Export AWS Budgets with alerts, thresholds, actual vs forecasted spend tracking"
                },
                "6": {
                    "name": "Reserved Instances",
                    "file": scripts_dir / "reserved-instances-export.py",
                    "description": "Export Reserved Instances across EC2, RDS, ElastiCache, OpenSearch, Redshift, MemoryDB with utilization and expiration tracking"
                },
                "7": {
                    "name": "Cost Categories",
                    "file": scripts_dir / "cost-categories-export.py",
                    "description": "Export Cost Categories definitions, rules, inherited values, and split charge configurations"
                },
                "8": {
                    "name": "Cost Anomaly Detection",
                    "file": scripts_dir / "cost-anomaly-detection-export.py",
                    "description": "Export Cost Anomaly Detection monitors, subscriptions, anomalies, and root cause analysis"
                },
                "9": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "9": {
            "name": "Integration & Messaging",
            "submenu": {
                "1": {
                    "name": "API Gateway",
                    "file": scripts_dir / "api-gateway-export.py",
                    "description": "Export API Gateway REST APIs, HTTP APIs, stages, and custom domains"
                },
                "2": {
                    "name": "EventBridge",
                    "file": scripts_dir / "eventbridge-export.py",
                    "description": "Export EventBridge event buses, rules, targets, and archives"
                },
                "3": {
                    "name": "SQS/SNS",
                    "file": scripts_dir / "sqs-sns-export.py",
                    "description": "Export SQS queues and SNS topics with subscriptions and configurations"
                },
                "4": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "10": {
            "name": "Monitoring & Operations",
            "submenu": {
                "1": {
                    "name": "CloudWatch",
                    "file": scripts_dir / "cloudwatch-export.py",
                    "description": "Export CloudWatch alarms, log groups, and metric filters"
                },
                "2": {
                    "name": "Systems Manager Fleet",
                    "file": scripts_dir / "ssm-fleet-export.py",
                    "description": "Export SSM managed instances, patch compliance, and parameters"
                },
                "3": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "11": {
            "name": "Database Resources",
            "submenu": {
                "1": {
                    "name": "DynamoDB",
                    "file": scripts_dir / "dynamodb-export.py",
                    "description": "Export DynamoDB tables, GSIs, backups, and configuration details"
                },
                "2": {
                    "name": "ElastiCache",
                    "file": scripts_dir / "elasticache-export.py",
                    "description": "Export ElastiCache (Redis/Memcached) clusters, replication groups, and subnet groups"
                },
                "3": {
                    "name": "DocumentDB",
                    "file": scripts_dir / "documentdb-export.py",
                    "description": "Export DocumentDB (MongoDB-compatible) clusters, instances, and snapshots"
                },
                "4": {
                    "name": "Neptune",
                    "file": scripts_dir / "neptune-export.py",
                    "description": "Export Neptune (Graph Database) clusters, instances, snapshots, and endpoints"
                },
                "5": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "12": {
            "name": "Analytics & Data",
            "submenu": {
                "1": {
                    "name": "OpenSearch Service",
                    "file": scripts_dir / "opensearch-export.py",
                    "description": "Export OpenSearch domains, VPC configs, encryption, access policies, and snapshots"
                },
                "2": {
                    "name": "Redshift",
                    "file": scripts_dir / "redshift-export.py",
                    "description": "Export Redshift data warehouse clusters, snapshots, parameter groups, and subnet groups"
                },
                "3": {
                    "name": "Glue & Athena",
                    "file": scripts_dir / "glue-athena-export.py",
                    "description": "Export Glue databases, tables, crawlers, jobs, and Athena workgroups/catalogs"
                },
                "4": {
                    "name": "Lake Formation",
                    "file": scripts_dir / "lakeformation-export.py",
                    "description": "Export Lake Formation resources, permissions, data lake settings, and LF-Tags"
                },
                "5": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "13": {
            "name": "Application Services",
            "submenu": {
                "1": {
                    "name": "Step Functions",
                    "file": scripts_dir / "stepfunctions-export.py",
                    "description": "Export Step Functions state machines, executions, and activities"
                },
                "2": {
                    "name": "App Runner",
                    "file": scripts_dir / "apprunner-export.py",
                    "description": "Export App Runner services, auto scaling configs, VPC connectors, and custom domains"
                },
                "3": {
                    "name": "Elastic Beanstalk",
                    "file": scripts_dir / "elasticbeanstalk-export.py",
                    "description": "Export Elastic Beanstalk applications, environments, versions, and config templates"
                },
                "4": {
                    "name": "AppSync",
                    "file": scripts_dir / "appsync-export.py",
                    "description": "Export AppSync GraphQL APIs, data sources, resolvers, and API keys"
                },
                "5": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "14": {
            "name": "Advanced Security & Identity",
            "submenu": {
                "1": {
                    "name": "Macie",
                    "file": scripts_dir / "macie-export.py",
                    "description": "Export Macie data security service: classification jobs, findings, and sensitive data discovery"
                },
                "2": {
                    "name": "Cognito",
                    "file": scripts_dir / "cognito-export.py",
                    "description": "Export Cognito user pools, identity pools, clients, providers, and groups"
                },
                "3": {
                    "name": "ACM Private CA",
                    "file": scripts_dir / "acm-privateca-export.py",
                    "description": "Export ACM Private Certificate Authorities, certificates, templates, and permissions"
                },
                "4": {
                    "name": "IAM Identity Providers",
                    "file": scripts_dir / "iam-identity-providers-export.py",
                    "description": "Export IAM SAML and OIDC identity providers with role trust relationships"
                },
                "5": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "15": {
            "name": "AI & Machine Learning",
            "submenu": {
                "1": {
                    "name": "SageMaker",
                    "file": scripts_dir / "sagemaker-export.py",
                    "description": "Export SageMaker notebooks, training jobs, models, endpoints, and processing jobs"
                },
                "2": {
                    "name": "Bedrock",
                    "file": scripts_dir / "bedrock-export.py",
                    "description": "Export Bedrock foundation models, custom models, guardrails, knowledge bases, and agents"
                },
                "3": {
                    "name": "Comprehend",
                    "file": scripts_dir / "comprehend-export.py",
                    "description": "Export Comprehend entity recognizers, classifiers, endpoints, and NLP jobs"
                },
                "4": {
                    "name": "Rekognition",
                    "file": scripts_dir / "rekognition-export.py",
                    "description": "Export Rekognition custom models, face collections, stream processors, and projects"
                },
                "5": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "16": {
            "name": "Developer Tools & CI/CD",
            "submenu": {
                "1": {
                    "name": "CodeBuild",
                    "file": scripts_dir / "codebuild-export.py",
                    "description": "Export CodeBuild projects, builds, and report groups"
                },
                "2": {
                    "name": "CodePipeline",
                    "file": scripts_dir / "codepipeline-export.py",
                    "description": "Export CodePipeline pipelines, executions, and webhooks"
                },
                "3": {
                    "name": "CodeCommit",
                    "file": scripts_dir / "codecommit-export.py",
                    "description": "Export CodeCommit repositories, branches, and pull requests"
                },
                "4": {
                    "name": "CodeDeploy",
                    "file": scripts_dir / "codedeploy-export.py",
                    "description": "Export CodeDeploy applications, deployment groups, and deployments"
                },
                "5": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "17": {
            "name": "Management & Governance",
            "submenu": {
                "1": {
                    "name": "CloudFormation",
                    "file": scripts_dir / "cloudformation-export.py",
                    "description": "Export CloudFormation stacks, StackSets, resources, and drift detection status"
                },
                "2": {
                    "name": "Service Catalog",
                    "file": scripts_dir / "service-catalog-export.py",
                    "description": "Export Service Catalog portfolios, products, provisioned products, and access controls"
                },
                "3": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        },
        "18": {
            "name": "Output Management",
            "submenu": {
                "1": {
                    "name": "Create Output Archive",
                    "file": None,
                    "description": "Create a zip archive of all exported files",
                    "action": "create_archive"
                },
                "2": {
                    "name": "Return to Main Menu",
                    "file": None,
                    "description": "Return to the main menu"
                }
            }
        }
    }
    
    # Verify the script files exist (only for actual scripts)
    for main_option, main_info in menu_structure.items():
        if "submenu" in main_info:
            for sub_option, sub_info in main_info["submenu"].items():
                if sub_info.get("file") and not sub_info["file"].exists():
                    print(f"Warning: Script file {sub_info['file']} for submenu option {main_option}.{sub_option} ({sub_info['name']}) not found!")
        elif main_info.get("file") and main_info["file"] is not None and not main_info["file"].exists():
            print(f"Warning: Script file {main_info['file']} for main menu option {main_option} ({main_info['name']}) not found!")
    
    return menu_structure

def display_main_menu():
    """
    Display the main menu with categories.
    
    Returns:
        tuple: (menu_structure, exit_option) - The menu structure and exit option
    """
    # Get the menu structure
    menu_structure = get_menu_structure()
    
    # Display the main menu options
    print("\nMAIN MENU:")
    print("====================================================================")
    
    for option, info in menu_structure.items():
        print(f"{option}. {info['name']}")
    
    # Add exit option
    exit_option = str(len(menu_structure) + 1)
    print(f"{exit_option}. Exit")
    
    return menu_structure, exit_option

def display_submenu(submenu, category_name):
    """
    Display a submenu for a specific category.
    
    Args:
        submenu (dict): The submenu options
        category_name (str): The name of the category
        
    Returns:
        dict: The submenu structure
    """
    # Clear the screen
    clear_screen()
    
    print(f"====================================================================")
    print(f"                  {category_name.upper()}")
    print(f"====================================================================")
    
    # Display the submenu options
    print("\nSelect an option:")
    for option, info in submenu.items():
        print(f"{option}. {info['name']} - {info['description']}")
    
    return submenu


def handle_submenu(category_option, account_name):
    """
    Handle the submenu navigation and script execution.
    
    Args:
        category_option (dict): The selected main menu option with submenu
        account_name (str): The AWS account name for archive creation
    """
    while True:
        # Display submenu for this category
        submenu = display_submenu(category_option["submenu"], category_option["name"])
        
        # Get user choice
        print("\nSelect an option:")
        user_choice = input("> ")
        
        # Handle return to main menu
        if user_choice in submenu:
            selected_option = submenu[user_choice]

            # Log submenu selection
            submenu_path = f"{category_option.get('name', 'Unknown')}.{user_choice}"
            utils.log_menu_selection(submenu_path, selected_option['name'])

            # Check if this is the "Return to Main Menu" or "Return to Previous Menu" option
            if selected_option["name"] in ["Return to Main Menu", "Return to Previous Menu"]:
                utils.log_info(f"User selected: {selected_option['name']}")
                return

            # Check if this option has its own submenu (nested submenu)
            if "submenu" in selected_option:
                handle_submenu(selected_option, account_name)
                continue

            # Check if this is a special action (like Create Output Archive)
            if selected_option.get("action") == "create_archive":
                print(f"\nYou selected: {selected_option['name']} - {selected_option['description']}")
                
                # Confirm execution
                confirm = input("Do you want to continue? (y/n): ").lower()
                if confirm == 'y':
                    create_output_archive(account_name)
                    # Ask if user wants to perform another action from this submenu
                    another = input("\nWould you like to perform another action from this menu? (y/n): ").lower()
                    if another != 'y':
                        return  # Return to main menu
                continue
            
            # Handle regular script execution
            print(f"\nYou selected: {selected_option['name']} - {selected_option['description']}")

            # Confirm execution
            confirm = input("Do you want to continue? (y/n): ").lower()
            if confirm == 'y':
                # Execute the script
                if selected_option["file"]:
                    success = execute_script(selected_option["file"])
                    
                    # Ask if user wants to run another tool from this submenu
                    another = input("\nWould you like to run another tool from this menu? (y/n): ").lower()
                    if another != 'y':
                        return  # Return to main menu
                
            # If user didn't confirm, stay in the submenu
        
        else:
            print("Invalid selection. Please try again.")

def navigate_menus():
    """
    Display the main menu and handle user navigation through nested menus.
    """
    try:
        # Print header and get account information
        account_id, account_name = print_header()
        
        # Check dependencies
        if not check_dependencies():
            print("Required dependencies are missing. Please install them to continue.")
            sys.exit(1)
        
        # Ensure directory structure
        ensure_directory_structure()
        
        # Main menu loop
        while True:
            # Get menu structure
            menu_structure, exit_option = display_main_menu()
            
            if not menu_structure:
                print("\nNo scripts found in the mapping. Please ensure script files exist in the scripts directory.")
                sys.exit(1)
            
            print("\nSelect an option:")
            user_choice = input("> ")
            
            # Exit option
            if user_choice == exit_option:
                clear_screen()
                print("Exiting StratusScan. Thank you for using the tool.")
                break
            
            # Main menu option
            elif user_choice in menu_structure:
                selected_option = menu_structure[user_choice]

                # Log menu selection
                utils.log_menu_selection(user_choice, selected_option['name'])

                # If it's a direct script (like Create Output Archive or Configure StratusScan)
                if "file" in selected_option and "submenu" not in selected_option:
                    print(f"\nYou selected: {selected_option['name']} - {selected_option['description']}")

                    # Confirm execution
                    confirm = input("Do you want to continue? (y/n): ").lower()
                    if confirm == 'y':
                        utils.log_info(f"User confirmed execution of: {selected_option['name']}")
                        # Handle special case for creating output archive
                        if selected_option["name"] == "Create Output Archive":
                            create_output_archive(account_name)
                        # Handle Configure StratusScan
                        elif selected_option["name"] == "Configure StratusScan":
                            if selected_option["file"]:
                                success = execute_script(selected_option["file"])
                                if success:
                                    print("\nConfiguration completed successfully!")
                                    print("You may need to restart StratusScan for changes to take effect.")
                                else:
                                    print("\nConfiguration may not have completed successfully.")
                        # Handle other direct scripts
                        elif selected_option.get("file"):
                            execute_script(selected_option["file"])
                
                # If it's a submenu
                elif "submenu" in selected_option:
                    # Display the submenu and handle selection
                    handle_submenu(selected_option, account_name)
            
            else:
                print("Invalid selection. Please try again.")
    
    except KeyboardInterrupt:
        print("\nOperation cancelled by user.")
    except Exception as e:
        print(f"An unexpected error occurred: {e}")

def main():
    """
    Main function to display the menu and handle script execution.
    """
    try:
        utils.log_section("STARTING MAIN MENU NAVIGATION")
        navigate_menus()
    except KeyboardInterrupt:
        utils.log_info("User cancelled operation with Ctrl+C")
        print("\nOperation cancelled by user.")
        sys.exit(0)
    except Exception as e:
        print(f"Error in main function: {e}")
        utils.log_error("Error in main function", e)
        sys.exit(1)
    finally:
        # Log script completion
        utils.log_script_end("stratusscan.py", SCRIPT_START_TIME)

if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        utils.log_error("Fatal error in main execution", e)
        sys.exit(1)